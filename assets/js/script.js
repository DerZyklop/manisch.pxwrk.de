// Generated by CoffeeScript 1.6.1
(function() {
  var App, AppView, Item, ItemView, List, pxwrkHelpersForViews,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  Item = (function(_super) {

    __extends(Item, _super);

    function Item() {
      return Item.__super__.constructor.apply(this, arguments);
    }

    Item.prototype.defaults = {
      manisch: 'übersetzung fehlt',
      german: 'übersetzung fehlt'
    };

    return Item;

  })(Backbone.Model);

  List = (function(_super) {

    __extends(List, _super);

    function List() {
      return List.__super__.constructor.apply(this, arguments);
    }

    List.prototype.model = Item;

    List.prototype.byCategory = function(categoryName) {
      var result,
        _this = this;
      result = new List;
      _.each(this.models, function(item) {
        var currentItem;
        currentItem = item;
        return _.each(item.get('category'), function(categorie) {
          if (categorie === categoryName) {
            return result.add(currentItem);
          }
        });
      });
      return result;
    };

    List.prototype.search = function(searchParam) {
      var byInput, filtered,
        _this = this;
      if (!searchParam) {
        return this;
      }
      byInput = function(element, index, array) {
        var attributes, pattern;
        attributes = element.toJSON();
        pattern = RegExp(searchParam.toLowerCase());
        if (!attributes.german.toLowerCase().match(pattern) && !attributes.manisch.toLowerCase().match(pattern)) {
          return false;
        } else {
          return true;
        }
      };
      filtered = new List(this.filter(byInput));
      return filtered;
    };

    return List;

  })(Backbone.Collection);

  ItemView = (function(_super) {

    __extends(ItemView, _super);

    function ItemView() {
      return ItemView.__super__.constructor.apply(this, arguments);
    }

    ItemView.prototype.tagName = 'li';

    ItemView.prototype.initialize = function() {
      var _this = this;
      _.bindAll(this);
      return jQuery.ajax({
        url: 'site/templates/item.html',
        async: false,
        dataType: 'html',
        success: function(data) {
          return _this.template = data;
        },
        error: function() {}
      });
    };

    ItemView.prototype.render = function() {
      _.templateSettings = {
        interpolate: /\{\{(.+?)\}\}/g
      };
      jQuery(this.el).html(_.template(this.template, this.model.toJSON()));
      return this;
    };

    ItemView.prototype.unrender = function() {
      return $(this.el).remove();
    };

    return ItemView;

  })(Backbone.View);

  pxwrkHelpersForViews = (function(_super) {

    __extends(pxwrkHelpersForViews, _super);

    function pxwrkHelpersForViews() {
      return pxwrkHelpersForViews.__super__.constructor.apply(this, arguments);
    }

    pxwrkHelpersForViews.prototype.functionLog = function(name) {
      return console.log(name);
    };

    pxwrkHelpersForViews.prototype.valueHasChanged = (function() {
      var latestValue;
      latestValue = [];
      return function(value, id) {
        var result;
        if (value === latestValue[id]) {
          result = false;
        } else {
          latestValue[id] = value;
          result = true;
        }
        return result;
      };
    })();

    return pxwrkHelpersForViews;

  })(Backbone.View);

  AppView = (function(_super) {

    __extends(AppView, _super);

    function AppView() {
      return AppView.__super__.constructor.apply(this, arguments);
    }

    AppView.prototype.el = '#list';

    AppView.prototype.translations = new List;

    AppView.prototype.visibleTranslations = new List;

    AppView.prototype.getItemsBySearch = function(searchParam) {
      var searchResult,
        _this = this;
      if (searchParam == null) {
        searchParam = false;
      }
      this.functionLog('getItemsBySearch(' + searchParam + ')');
      this.removeAllItems();
      searchResult = this.visibleTranslations.search(searchParam);
      return _.each(searchResult.models, function(item) {
        return _this.appendItem(item);
      });
    };

    AppView.prototype.getItemsByCategory = function(categoryName) {
      this.functionLog('getItemsByCategory()');
      jQuery('.sort.active').removeClass('active');
      jQuery('#' + categoryName).addClass('active');
      this.removeAllItems();
      if (categoryName === 'all') {
        return this.appendItems(this.translations);
      } else {
        return this.appendItems(this.translations.byCategory(categoryName));
      }
    };

    AppView.prototype.appendItem = function(item) {
      var item_view;
      this.functionLog('appendItem()');
      item_view = new ItemView({
        model: item
      });
      return $(this.el).append(item_view.render().el);
    };

    AppView.prototype.appendItems = function(collection) {
      var _this = this;
      this.visibleTranslations = collection;
      return _.each(collection.models, function(item) {
        item.set('currentlyVisible', true);
        return _this.appendItem(item);
      });
    };

    AppView.prototype.removeAllItems = function() {
      _.each(this.translations.models, function(item) {
        return item.set('currentlyVisible', false);
      });
      return $(this.el).html('');
    };

    AppView.prototype.setFocusToFirstInput = function() {
      return jQuery('input:visible:first:text').focus();
    };

    AppView.prototype.searchTimeout = false;

    AppView.prototype.stopSearch = function() {
      console.log('stopSearch');
      return clearTimeout(this.searchTimeout);
    };

    AppView.prototype.render = function() {
      var _this = this;
      this.functionLog('render()');
      this.getItemsByCategory('all');
      jQuery('.sort').on('click', function(event) {
        var categoryName;
        _this.stopSearch();
        jQuery('#search').val('');
        _this.setFocusToFirstInput();
        categoryName = jQuery(event.target).attr('id');
        return _this.getItemsByCategory(categoryName);
      });
      this.setFocusToFirstInput();
      return jQuery('#search').on('keyup', function(event) {
        var id, val;
        val = jQuery(event.target).val();
        id = jQuery(event.target).attr('id');
        if (_this.valueHasChanged(val, id)) {
          if (val === '') {
            clearTimeout(_this.searchTimeout);
            return _this.getItemsBySearch();
          } else {
            clearTimeout(_this.searchTimeout);
            return _this.searchTimeout = setTimeout(function() {
              return _this.getItemsBySearch(val);
            }, 10);
          }
        }
      });
    };

    AppView.prototype.events = {
      'click .sort': 'getItemsByCategory'
    };

    AppView.prototype.initialize = function() {
      var _this = this;
      this.functionLog('initialize()');
      _.bindAll(this);
      this.translations.fetch({
        url: 'content/manisch.json',
        success: function() {
          return _this.appendItems(_this.translations);
        }
      });
      return this.render();
    };

    return AppView;

  })(pxwrkHelpersForViews);

  App = new AppView;

}).call(this);
